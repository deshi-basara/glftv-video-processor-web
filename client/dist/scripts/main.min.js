/*!
* Simon Schuster <simon.schuster@hs-furtwangen.de>
* glftv-video-processor-web v0.9.0 (https://github.com/deshi-basara/glftv-video-processor-web)
*/
"use strict";angular.module("app",["ui.router","ui.bootstrap","LocalStorageModule","ngAnimate","angular-svg-round-progress","ngTable","angularFileUpload","oitozero.ngSweetAlert","formly","truncate"]).constant("config",{name:"development",apiUrl:"http://localhost:1337"}).config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("login",{url:"/login",templateUrl:"scripts/routes/login/login.index.tpl.html",controller:"LoginCtrl",controllerAs:"ctrl"}).state("register",{url:"/register",templateUrl:"scripts/routes/register/register.index.tpl.html",controller:"RegisterCtrl",controllerAs:"ctrl"}).state("dash",{url:"","abstract":!0,templateUrl:"scripts/routes/dash/dash.index.tpl.html",controller:"DashCtrl",controllerAs:"ctrl"}).state("dash.job",{url:"/job",controller:"JobCtrl",controllerAs:"ctrl",templateUrl:"scripts/routes/job/job.index.tpl.html"}).state("dash.queue",{url:"/queue",controller:"QueueCtrl",controllerAs:"ctrl",templateUrl:"scripts/routes/queue/queue.index.tpl.html"}).state("dash.profiles",{url:"/profile",controller:"ProfilesCtrl",controllerAs:"ctrl",templateUrl:"scripts/routes/profiles/profiles.index.tpl.html"}).state("dash.settings",{url:"/settings",controller:"SettingsCtrl",controllerAs:"ctrl",templateUrl:"scripts/routes/settings/settings.index.tpl.html"}),t.otherwise("queue")}]).run(["$state","AuthService","SocketService",function(e,t,r){r.connectSocket(),t.hasSession().then(function(){},function(){})}]),function(){function e(){var e={transclude:!0,templateUrl:"scripts/directives/tpl/agsLoader.html",restrict:"EA"};return e}angular.module("app").directive("agsLoader",e)}(),function(){function e(){return function(e,t){if(0===e)return"0 B";if(isNaN(parseFloat(e))||!isFinite(e))return"-";var r=0>e;r&&(e=-e),"undefined"==typeof t&&(t=1);var n=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],o=Math.min(Math.floor(Math.log(e)/Math.log(1024)),n.length-1),l=(e/Math.pow(1024,Math.floor(o))).toFixed(t);return(r?"-":"")+l+" "+n[o]}}angular.module("app").filter("agsBytes",e)}(),function(){function e(){function e(e,t){var r=t.children().children();e.$watch("progress",function(t){r.css({width:t+"%"}),e.progress=t}),e.$watch("status",function(e){"Fehler"===e&&r.parent().css({"background-color":"#DD0039"})})}var t={restrict:"E",templateUrl:"scripts/directives/progress/progress.ags.tpl.html",scope:{progress:"@",status:"@"},link:e,controller:"JobCtrl",controllerAs:"ctrl"};return t}angular.module("app").directive("agsProgress",e)}(),function(){function e(e){var t=this;angular.extend(t,{currentProgress:0,currentName:"Kein laufender Prozess",globalProgress:0}),e.socket.on("stats.progress.update",function(e){t.currentProgress=e.progress,t.currentName=e.name})}angular.module("app").controller("DashCtrl",e),e.$inject=["SocketService"]}(),function(){function e(e,t,r,n,o,l){function i(e){var t=d.fileSelected.custom.indexOf(e);-1===t?d.fileSelected.custom.push(e):d.fileSelected.custom.shift(t)}function s(){r.getAllProfiles().then(function(e){d.profiles=e},function(e){n.swal("Server-Fehler",e,"error")})}function a(e){d.filesInUploadQueue=e;for(var r=0;r<d.filesInUploadQueue.length;r++)d.filesInUploadQueue[r].progress=parseInt(0),d.filesInUploadQueue[r].status="Uploading",t.uploadFile(d.filesInUploadQueue[r]).then(function(){},function(e,t){return null===t?n.swal("Der Upload-Server ist nicht erreichbar"):void 0},null)}function u(e){e.custom=[],d.fileSelected=e}function c(){}function f(){o.open({templateUrl:"server-modal.html",controller:"JobModalCtrl",controllerAs:"modal",size:"lg"})}function g(){for(var e=0;e<d.filesInUploadQueue.length;e++){var r=d.filesInUploadQueue[e];"Bereit"===r.status&&0!==r.custom.length?t.startQueue(r.uploadId,r.custom).then(function(){r.status="Fertig"},function(){r.status="Fehler"},function(e){console.log(e)}):"Bereit"===r.status&&0===r.custom.length&&(r.noProfile=!0)}}var d=this;angular.extend(d,{filesInUploadQueue:[],fileSelected:null,profiles:null,customProfiles:i,onFileSelect:a,onVideoSelect:u,onProfileSelect:c,onServerSelect:f,queueUploadedVideos:g}),l.$on("modal.server.selectedFiles",function(e,r){d.filesInUploadQueue=r;for(var n=0;n<d.filesInUploadQueue.length;n++)t.createModel(d.filesInUploadQueue[n]).then(function(e){console.log(e)},function(){})}),s()}angular.module("app").controller("JobCtrl",e),e.$inject=["ngTableParams","JobService","ProfileService","SweetAlert","$modal","$scope"]}(),function(){function e(e,t,r,n){function o(){e.dismiss("cancel")}function l(){if(null!==a.foundFiles)for(var e=0;e<a.foundFiles.length;e++)a.foundFiles[e].selected=!0}function i(){return a.isSearching=!0,null===a.searchString?void r(function(){a.isSearching=!1},500):void t.startSearch(a.searchString).then(function(e){a.isSearching=!1,a.foundFiles=e,a.totalFiles=e.length},function(){})}function s(){for(var e=[],t=0;t<a.foundFiles.length;t++)a.foundFiles[t].selected===!0&&(a.foundFiles[t].status="Upload",e.push(a.foundFiles[t]));0!==e.length&&n.$broadcast("modal.server.selectedFiles",e),o()}var a=this;angular.extend(a,{isSearching:!1,searchString:null,selectedFiles:0,totalFiles:0,foundFiles:null,closeModal:o,okModal:s,selectAll:l,startSearch:i}),i()}angular.module("app").controller("JobModalCtrl",e),e.$inject=["$modalInstance","JobService","$timeout","$rootScope"]}(),function(){function e(e,t,r,n){function o(e){var o=n.defer();return t({method:"POST",url:r.apiUrl+a.modelUrl,data:{name:e.name,path:e.path}}).success(function(t){e.progress=100,e.status="Bereit",e.uploadId=t.id,o.resolve(t)}).error(function(t,r){e.status="Fehler",o.reject(t,r)}),o.promise}function l(t){var o=n.defer();return e.upload({method:"POST",url:r.apiUrl+a.uploadUrl,file:t,fileFormDataName:"videoFile"}).progress(function(e){t.progress=parseInt(100*e.loaded/e.total)}).success(function(e){t.status="Bereit",t.uploadId=e.id,o.resolve(e)}).error(function(e,r){t.status="Fehler",o.reject(e,r)}),o.promise}function i(e,o){var l=n.defer();return console.log("starting: "+e+" + "+o),t({method:"POST",url:r.apiUrl+a.startUrl,data:{id:e,profiles:o}}).success(function(){l.resolve()}).error(function(e,t){l.reject(e,t)}),l.promise}function s(e){var o=n.defer();return console.log("search: "+e),t({method:"POST",url:r.apiUrl+a.searchUrl,data:{path:e}}).success(function(e){o.resolve(e)}).error(function(e,t){o.reject(e,t)}),o.promise}var a={modelUrl:"/videos/model",uploadUrl:"/videos/upload",searchUrl:"/videos/search",startUrl:"/videos/start",createModel:o,uploadFile:l,startQueue:i,startSearch:s};return a}angular.module("app").factory("JobService",e),e.$inject=["$upload","$http","config","$q"]}(),function(){function e(e,t,r){function n(){return 0===o.login.user.length||0===o.login.pass.length?(o.errorMsg="Du hast nicht alle Formular-Felder ausgefÃ¼llt",o.showError=!0,void t(function(){o.showError=!1},5e3)):void e.getAuth(o.login).then(function(){r.go("dash.job")},function(){})}var o=this;angular.extend(o,{login:{user:"",pass:""},showError:!1,submitLogin:n})}angular.module("app").controller("LoginCtrl",e),e.$inject=["AuthService","$timeout","$state"]}(),function(){function e(e,t){function r(e){u.isActive=e}function n(){var e=u.newProfile.outputFormat;console.log(e),console.log(u.allGlobalSettings);for(var t=0;t<u.allGlobalSettings.length;t++)if(u.allGlobalSettings[t].name===e)return u.allProfileSettings=u.allGlobalSettings[t]}function o(){u.showSettingBox=!0,u.newProfile={}}function l(){t.getAllProfiles().then(function(e){u.allProfiles=e,u.tableParams.reload()},function(){})}function i(){t.getAllProfileSettings().then(function(e){u.allGlobalSettings=e},function(){})}function s(e){u.showSettingBox=!0,u.newProfile=e,n();var t=angular.fromJson(u.newProfile.json);angular.forEach(t,function(e,t){u.newProfile[t]=e})}function a(){t.submitNewProfile(u.newProfile).then(function(){l()},function(){})}var u=this;l(),i();var c=new e({page:1,count:10},{total:0,counts:[],getData:function(e,t){if(u.allProfiles){t.total(u.allProfiles.length);var r=u.allProfiles.slice((t.page()-1)*t.count(),t.page()*t.count());e.resolve(r)}}});angular.extend(u,{isActive:"global",showSettingBox:!1,allProfiles:null,allGlobalSettings:[],allProfileSettings:[],newProfile:{},tableParams:c,changeActive:r,changeOutputFormat:n,createNewProfile:o,onProfileSelect:s,submitNewProfile:a})}angular.module("app").controller("ProfilesCtrl",e),e.$inject=["ngTableParams","ProfileService","SweetAlert"]}(),function(){function e(e,t,r,n){function o(t){e.cancelJob(t).then(function(){l()},function(){})}function l(){e.getAllInQueue().then(function(e){a.queueData=e,a.tableParams.reload()},function(){})}function i(){for(var t=[],r=0;r<a.queueData.length;r++){var n=a.queueData[r];"failed"===n.status&&t.push(n.id)}t.length>0&&e.removeAll(t).then(function(e){console.log(e),l()},function(){})}function s(){for(var t=[],r=0;r<a.queueData.length;r++){var n=a.queueData[r];"finished"===n.status&&t.push(n.id)}t.length>0&&e.removeAll(t).then(function(e){console.log(e),l()},function(){})}var a=this,u=new t({page:1,count:15},{total:0,counts:[],getData:function(e,t){if(a.queueData){t.total(a.queueData.length);var r=a.queueData.slice((t.page()-1)*t.count(),t.page()*t.count());e.resolve(r)}}});angular.extend(a,{queueData:null,tableParams:u,cancelSelected:o,removeAllFailed:i,removeAllFinished:s}),r.socket.on("stats.progress.update",function(e){for(var t=0;t<a.queueData.length;t++)if(a.queueData[t].id===e.id)return a.queueData[t].progress=e.progress,n.$apply()}),l()}angular.module("app").controller("QueueCtrl",e),e.$inject=["QueueService","ngTableParams","SocketService","$scope"]}(),function(){function e(e,t,r){function n(n){var o=r.defer();return e({method:"DELETE",url:t.apiUrl+i.cancelUrl,data:{id:n}}).success(function(e){o.resolve(e)}).error(function(e,t){o.reject(e,t)}),o.promise}function o(){var n=r.defer();return e({method:"GET",url:t.apiUrl+i.allUrl}).success(function(e){n.resolve(e)}).error(function(e,t){n.reject(e,t)}),n.promise}function l(n){var o=r.defer();return e({method:"DELETE",url:t.apiUrl+i.removeUrl,data:{removeIds:n}}).success(function(e){o.resolve(e)}).error(function(e,t){o.reject(e,t)}),o.promise}var i={allUrl:"/stats/all",cancelUrl:"/stats/cancel",removeUrl:"/stats/remove",cancelJob:n,getAllInQueue:o,removeAll:l};return i}angular.module("app").factory("QueueService",e),e.$inject=["$http","config","$q"]}(),function(){function e(e,t){function r(){return n.register={name:"Simon Schuster",mail:"simon.schuster@hs-furtwangen.de",pass:"Simon123",pass2:"Simon123"},0===n.register.name.length||0===n.register.mail.length||0===n.register.pass.length||0===n.register.pass2.length?(n.errorMsg="Du hast nicht alle Formular-Felder ausgefÃ¼llt",n.showError=!0,void t(function(){n.showError=!1},5e3)):n.register.pass!==n.register.pass2?(n.errorMsg="Die PasswÃ¶rter stimmen nicht Ã¼berein",n.showError=!0,void t(function(){n.showError=!1},5e3)):void e.getRegistration(n.register).then(function(e){console.log(e)},function(e){console.log(e)})}var n=this;angular.extend(n,{register:{name:"",mail:"",pass:"",pass2:""},showError:!1,submitRegistration:r})}angular.module("app").controller("RegisterCtrl",e),e.$inject=["AuthService","$timeout"]}(),function(){function e(e,t,r){function n(){t.getAllProfileSettings().then(function(e){a.allSettings=e},function(e){r.swal("Server-Fehler",e,"error")})}function o(e){a.selectedSetting=s(e,4)}function l(e){t.removeSetting(e).then(function(){n()},function(e){r.swal("Server-Fehler",e,"error")})}function i(){if(a.selectedSetting){try{var e=JSON.parse(a.selectedSetting)}catch(o){return r.swal("Eingabe-Fehler","Kein gÃ¼ltiger JSON-String","error")}e.name||r.swal("Eingabe-Fehler","Kein gÃ¼ltiger Name eingegeben","error"),t.submitNewSettings(e).then(function(){n()},function(e){r.swal("Server-Fehler",e,"error")})}}function s(e,t){return JSON.stringify(e,null,Number(t))}var a=this;angular.extend(a,{allSettings:null,newOne:!1,selectedSetting:null,insertSettings:o,removeSetting:l,submitNewSettings:i}),n()}angular.module("app").controller("SettingsCtrl",e),e.$inject=["ngTableParams","ProfileService","SweetAlert","$modal","$scope"]}(),function(){function e(e,t,r){function n(){var n=r.defer();return e({method:"POST",url:t.apiUrl+i.sessionUrl}).success(function(e){n.resolve(e)}).error(function(e,t){n.reject(e,t)}),n.promise}function o(n){var o=r.defer();return e({method:"POST",url:t.apiUrl+i.loginUrl,data:{mail:n.user,pass:n.pass}}).success(function(e){o.resolve(e)}).error(function(e,t){o.reject(e,t)}),o.promise}function l(n){var o=r.defer();return console.log(n),e({method:"POST",url:t.apiUrl+i.registerUrl,data:n}).success(function(e){o.resolve(e)}).error(function(e,t){o.reject(e,t)}),o.promise}var i={loginUrl:"/user/login",registerUrl:"/user/register",sessionUrl:"/user/session",hasSession:n,getAuth:o,getRegistration:l};return i}angular.module("app").factory("AuthService",e),e.$inject=["$http","config","$q","localStorageService"]}(),function(){function e(e,t,r){function n(){var n=r.defer();return e({method:"GET",url:t.apiUrl+a.allProfilesUrl}).success(function(e){n.resolve(e)}).error(function(e,t){n.reject(e,t)}),n.promise}function o(){var n=r.defer();return e({method:"GET",url:t.apiUrl+a.allSettingsUrl}).success(function(e){for(var t=0;t<e.length;t++){var r=e[t].json;e[t]=JSON.parse(r)}n.resolve(e)}).error(function(e,t){n.reject(e,t)}),n.promise}function l(n){var o=r.defer();return console.log(n),e({method:"DELETE",url:t.apiUrl+a.removeSettingUrl,data:{name:n}}).success(function(e){o.resolve(e)}).error(function(e,t){o.reject(e,t)}),o.promise}function i(n){var o=r.defer();return e({method:"POST",url:t.apiUrl+a.newProfileUrl,data:{profile:n}}).success(function(e){o.resolve(e)}).error(function(e,t){o.reject(e,t)}),o.promise}function s(n){var o=r.defer();return e({method:"POST",url:t.apiUrl+a.newSettingsUrl,data:{name:n.name,settings:n}}).success(function(e){o.resolve(e)}).error(function(e,t){o.reject(e,t)}),o.promise}var a={allProfilesUrl:"/profiles/all",allSettingsUrl:"/settings/all",newProfileUrl:"/profiles/save",newSettingsUrl:"/settings/save",removeSettingUrl:"/settings/remove",getAllProfiles:n,getAllProfileSettings:o,removeSetting:l,submitNewProfile:i,submitNewSettings:s};return a}angular.module("app").factory("ProfileService",e),e.$inject=["$http","config","$q"]}(),function(){function e(e,t,r){function n(){try{l.socket=io.connect("http://localhost:1337")}catch(e){return r.swal("Es konnte keine Verbindung zum WebSocket hergetsellt werden")}l.socket.on("connect",function(){o()})}function o(){}var l={socket:null,connectSocket:n};return l}angular.module("app").factory("SocketService",e),e.$inject=["config","$q","SweetAlert"]}();