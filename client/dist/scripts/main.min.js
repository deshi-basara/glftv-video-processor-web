/*!
* Simon Schuster <simon.schuster@hs-furtwangen.de>
* glftv-video-processor-web v0.9.5 (https://github.com/deshi-basara/glftv-video-processor-web)
*/
"use strict";angular.module("app",["ui.router","ui.bootstrap","LocalStorageModule","ngAnimate","angular-svg-round-progress","ngTable","angularFileUpload","oitozero.ngSweetAlert","formly","truncate"]).constant("config",{name:"GLF-Video-Processor",version:"0.9.5",apiUrl:"http://localhost:1337"}).config(["$httpProvider","$stateProvider","$urlRouterProvider","localStorageServiceProvider","config",function(e,r,t,n,o){function l(){r.state("login",{url:"/login",templateUrl:"scripts/routes/login/login.index.tpl.html",controller:"LoginCtrl",controllerAs:"ctrl"}).state("register",{url:"/register",templateUrl:"scripts/routes/register/register.index.tpl.html",controller:"RegisterCtrl",controllerAs:"ctrl"}).state("dash",{url:"","abstract":!0,templateUrl:"scripts/routes/dash/dash.index.tpl.html",controller:"DashCtrl",controllerAs:"ctrl"}).state("dash.job",{url:"/job",controller:"JobCtrl",controllerAs:"ctrl",templateUrl:"scripts/routes/job/job.index.tpl.html",resolve:{auth:["$http",function(e){return e.get(o.apiUrl+"/user/auth")}]}}).state("dash.queue",{url:"/queue",controller:"QueueCtrl",controllerAs:"ctrl",templateUrl:"scripts/routes/queue/queue.index.tpl.html",resolve:{auth:["$http",function(e){return e.get(o.apiUrl+"/user/auth")}]}}).state("dash.profiles",{url:"/profile",controller:"ProfilesCtrl",controllerAs:"ctrl",templateUrl:"scripts/routes/profiles/profiles.index.tpl.html",resolve:{auth:["$http",function(e){return e.get(o.apiUrl+"/user/auth")}]}}).state("dash.settings",{url:"/settings",controller:"SettingsCtrl",controllerAs:"ctrl",templateUrl:"scripts/routes/settings/settings.index.tpl.html",resolve:{auth:["$http",function(e){return e.get(o.apiUrl+"/user/auth")}],admin:["AuthService","$state",function(e,r){return 1!==e.getUserRole()?r.go("queue"):void 0}]}}),t.otherwise("queue")}function s(){n.setPrefix("glf-video")}function i(){e.interceptors.push(["$q",function(e){return{responseError:function(r){return 401===r.status&&(window.location.href="/#/login"),e.reject(r)}}}])}i(),l(),s()}]).run(["$injector","AuthService","config","$rootScope","SocketService",function(e,r,t,n,o){function l(){e.get("$http").defaults.transformRequest=function(e,t){var n=r.getToken(),o=r.getUserId();return n&&o&&(t().Authorization=n,t().User=o),e?angular.toJson(e):void 0}}function s(){angular.forEach(t,function(e,r){n[r]=e})}function i(){o.connectSocket()}l(),s(),i()}]),function(){function e(){return function(e,r){if(0===e)return"0 B";if(isNaN(parseFloat(e))||!isFinite(e))return"-";var t=0>e;t&&(e=-e),"undefined"==typeof r&&(r=1);var n=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],o=Math.min(Math.floor(Math.log(e)/Math.log(1024)),n.length-1),l=(e/Math.pow(1024,Math.floor(o))).toFixed(r);return(t?"-":"")+l+" "+n[o]}}angular.module("app").filter("agsBytes",e)}(),function(){function e(){function e(e,r){var t=r.children().children();e.$watch("progress",function(r){t.css({width:r+"%"}),e.progress=r}),e.$watch("status",function(e){"Fehler"===e&&t.parent().css({"background-color":"#DD0039"})})}var r={restrict:"E",templateUrl:"scripts/directives/progress/progress.ags.tpl.html",scope:{progress:"@",status:"@"},link:e,controller:"JobCtrl",controllerAs:"ctrl"};return r}angular.module("app").directive("agsProgress",e)}(),function(){function e(e,r,t){function n(){r.logout(),t.go("login")}var o=this;angular.extend(o,{currentProgress:0,currentName:"Kein laufender Prozess",currentUser:r.getUserName(),globalProgress:0,isAdmin:r.getUserRole(),submitLogout:n}),e.socket.on("stats.progress.update",function(e){o.currentProgress=e.progress,o.currentName=e.name})}angular.module("app").controller("DashCtrl",e),e.$inject=["SocketService","AuthService","$state"]}(),function(){function e(e,r,t,n,o,l){function s(e){var r=d.fileSelected.custom.indexOf(e);-1===r?d.fileSelected.custom.push(e):d.fileSelected.custom.shift(r)}function i(){t.getAllProfiles().then(function(e){d.profiles=e},function(e){n.swal("Server-Fehler",e,"error")})}function u(e){d.filesInUploadQueue=e;for(var t=0;t<d.filesInUploadQueue.length;t++)d.filesInUploadQueue[t].progress=parseInt(0),d.filesInUploadQueue[t].status="Uploading",r.uploadFile(d.filesInUploadQueue[t]).then(function(){},function(e){return null===status?n.swal("Server-Fehler","Der Upload-Server ist nicht erreichbar","error"):n.swal("Server-Fehler",e,"error")},null)}function a(e){e.custom=[],d.fileSelected=e}function c(){}function f(){o.open({templateUrl:"server-modal.html",controller:"JobModalCtrl",controllerAs:"modal",size:"lg"})}function g(){for(var e=0;e<d.filesInUploadQueue.length;e++){var t=d.filesInUploadQueue[e];"Bereit"===t.status&&0!==t.custom.length?r.startQueue(t.uploadId,t.custom).then(function(){t.status="Fertig"},function(){t.status="Fehler"},function(){}):"Bereit"===t.status&&0===t.custom.length&&(t.noProfile=!0)}}var d=this;angular.extend(d,{filesInUploadQueue:[],fileSelected:null,profiles:null,customProfiles:s,onFileSelect:u,onVideoSelect:a,onProfileSelect:c,onServerSelect:f,queueUploadedVideos:g}),l.$on("modal.server.selectedFiles",function(e,t){d.filesInUploadQueue=t;for(var n=0;n<d.filesInUploadQueue.length;n++)r.createModel(d.filesInUploadQueue[n]).then(function(e){console.log(e)},function(){})}),i()}angular.module("app").controller("JobCtrl",e),e.$inject=["ngTableParams","JobService","ProfileService","SweetAlert","$modal","$scope"]}(),function(){function e(e,r,t,n,o){function l(){e.dismiss("cancel")}function s(){if(0!==a.foundFiles)for(var e=0;e<a.foundFiles.length;e++)a.foundFiles[e].selected=!0}function i(){return a.isSearching=!0,null===a.searchString?void t(function(){a.isSearching=!1},500):void r.startSearch(a.searchString).then(function(e){a.isSearching=!1,a.foundFiles=e,a.totalFiles=e.length},function(e){o.swal("Server-Fehler",e,"error")})}function u(){for(var e=[],r=0;r<a.foundFiles.length;r++)a.foundFiles[r].selected===!0&&(a.foundFiles[r].status="Upload",e.push(a.foundFiles[r]));0!==e.length&&n.$broadcast("modal.server.selectedFiles",e),l()}var a=this;angular.extend(a,{isSearching:!1,searchString:null,selectedFiles:0,totalFiles:0,foundFiles:[],closeModal:l,okModal:u,selectAll:s,startSearch:i}),i()}angular.module("app").controller("JobModalCtrl",e),e.$inject=["$modalInstance","JobService","$timeout","$rootScope","SweetAlert"]}(),function(){function e(e,r,t,n,o){function l(e){var o=n.defer();return r({method:"POST",url:t.apiUrl+a.modelUrl,data:{name:e.name,path:e.path}}).success(function(r){e.progress=100,e.status="Bereit",e.uploadId=r.id,o.resolve(r)}).error(function(r,t){e.status="Fehler",o.reject(r,t)}),o.promise}function s(r){var l=n.defer();return e.upload({method:"POST",url:t.apiUrl+a.uploadUrl,file:r,fileFormDataName:"videoFile",data:{token:o.getToken(),id:o.getUserId()}}).progress(function(e){r.progress=parseInt(100*e.loaded/e.total)}).success(function(e){r.status="Bereit",r.uploadId=e.id,l.resolve(e)}).error(function(e,t){r.status="Fehler",l.reject(e,t)}),l.promise}function i(e,o){var l=n.defer();return console.log("starting: "+e+" + "+o),r({method:"POST",url:t.apiUrl+a.startUrl,data:{id:e,profiles:o}}).success(function(){l.resolve()}).error(function(e,r){l.reject(e,r)}),l.promise}function u(e){var o=n.defer();return console.log("search: "+e),r({method:"POST",url:t.apiUrl+a.searchUrl,data:{path:e}}).success(function(e){o.resolve(e)}).error(function(e,r){o.reject(e,r)}),o.promise}var a={modelUrl:"/videos/model",uploadUrl:"/videos/upload",searchUrl:"/videos/search",startUrl:"/videos/start",createModel:l,uploadFile:s,startQueue:i,startSearch:u};return a}angular.module("app").factory("JobService",e),e.$inject=["$upload","$http","config","$q","AuthService"]}(),function(){function e(e,r,t){function n(){return 0===o.login.user.length||0===o.login.pass.length?(o.errorMsg="Du hast nicht alle Formular-Felder ausgefüllt",o.showError=!0,void r(function(){o.showError=!1},5e3)):void e.getAuth(o.login).then(function(n){o.showSuccess=!0,e.saveToken(n.token),e.saveUserId(n.id),e.saveUserName(n.name),e.saveUserRole(n.role),r(function(){o.showSuccess=!1,r(function(){t.go("dash.queue")},800)},1500)},function(e){o.errorMsg=e,o.showError=!0,r(function(){o.showError=!1},5e3)})}var o=this;angular.extend(o,{login:{user:"",pass:""},showError:!1,showSuccess:!1,submitLogin:n})}angular.module("app").controller("LoginCtrl",e),e.$inject=["AuthService","$timeout","$state"]}(),function(){function e(e,r,t){function n(e){c.isActive=e}function o(){for(var e=c.newProfile.outputFormat,r=0;r<c.allGlobalSettings.length;r++)if(c.allGlobalSettings[r].name===e)return void(c.allProfileSettings=c.allGlobalSettings[r])}function l(){c.showSettingBox=!0,c.newProfile={}}function s(){r.getAllProfiles().then(function(e){c.allProfiles=e,c.tableParams.reload()},function(e){t.swal("Server-Fehler",e,"error")})}function i(){r.getAllProfileSettings().then(function(e){c.allGlobalSettings=e},function(e){t.swal("Server-Fehler",e,"error")})}function u(e){c.showSettingBox=!0,c.newProfile=e,o();var r=angular.fromJson(c.newProfile.json);angular.forEach(r,function(e,r){c.newProfile[r]=e})}function a(){r.submitNewProfile(c.newProfile).then(function(){s()},function(e){t.swal("Server-Fehler",e,"error")})}var c=this;s(),i();var f=new e({page:1,count:10},{total:0,counts:[],getData:function(e,r){if(c.allProfiles){r.total(c.allProfiles.length);var t=c.allProfiles.slice((r.page()-1)*r.count(),r.page()*r.count());e.resolve(t)}}});angular.extend(c,{isActive:"global",showSettingBox:!1,allProfiles:null,allGlobalSettings:[],allProfileSettings:[],newProfile:{},tableParams:f,changeActive:n,changeOutputFormat:o,createNewProfile:l,onProfileSelect:u,submitNewProfile:a})}angular.module("app").controller("ProfilesCtrl",e),e.$inject=["ngTableParams","ProfileService","SweetAlert"]}(),function(){function e(e,r,t,n,o){function l(r){e.cancelJob(r).then(function(){s()},function(){})}function s(){e.getAllInQueue().then(function(e){a.queueData=e,a.tableParams.reload()},function(e){return o.swal("Server-Fehler",e,"error")})}function i(){for(var r=[],t=0;t<a.queueData.length;t++){var n=a.queueData[t];"failed"===n.status&&r.push(n.id)}r.length>0&&e.removeAll(r).then(function(e){console.log(e),s()},function(e){return o.swal("Server-Fehler",e,"error")})}function u(){for(var r=[],t=0;t<a.queueData.length;t++){var n=a.queueData[t];"finished"===n.status&&r.push(n.id)}r.length>0&&e.removeAll(r).then(function(e){console.log(e),s()},function(e){return o.swal("Server-Fehler",e,"error")})}var a=this,c=new r({page:1,count:15},{total:0,counts:[],getData:function(e,r){if(a.queueData){r.total(a.queueData.length);var t=a.queueData.slice((r.page()-1)*r.count(),r.page()*r.count());e.resolve(t)}}});angular.extend(a,{queueData:null,tableParams:c,cancelSelected:l,removeAllFailed:i,removeAllFinished:u}),t.socket.on("stats.progress.update",function(e){for(var r=0;r<a.queueData.length;r++)if(a.queueData[r].id===e.id)return a.queueData[r].progress=e.progress,n.$apply()}),s()}angular.module("app").controller("QueueCtrl",e),e.$inject=["QueueService","ngTableParams","SocketService","$scope","SweetAlert"]}(),function(){function e(e,r,t){function n(n){var o=t.defer();return e({method:"DELETE",url:r.apiUrl+s.cancelUrl,data:{id:n}}).success(function(e){o.resolve(e)}).error(function(e,r){o.reject(e,r)}),o.promise}function o(){var n=t.defer();return e({method:"GET",url:r.apiUrl+s.allUrl}).success(function(e){n.resolve(e)}).error(function(e,r){n.reject(e,r)}),n.promise}function l(n){var o=t.defer();return e({method:"DELETE",url:r.apiUrl+s.removeUrl,data:{removeIds:n}}).success(function(e){o.resolve(e)}).error(function(e,r){o.reject(e,r)}),o.promise}var s={allUrl:"/stats/all",cancelUrl:"/stats/cancel",removeUrl:"/stats/remove",cancelJob:n,getAllInQueue:o,removeAll:l};return s}angular.module("app").factory("QueueService",e),e.$inject=["$http","config","$q"]}(),function(){function e(e,r,t){function n(){return 0===o.register.name.length||0===o.register.mail.length||0===o.register.pass.length||0===o.register.pass2.length?(o.errorMsg="Du hast nicht alle Formular-Felder ausgefüllt",o.showError=!0,void r(function(){o.showError=!1},5e3)):o.register.pass!==o.register.pass2?(o.errorMsg="Die Passwörter stimmen nicht überein",o.showError=!0,void r(function(){o.showError=!1},5e3)):void e.getRegistration(o.register).then(function(n){o.showSuccess=!0,e.saveToken(n.token),e.saveUserId(n.id),e.saveUserName(n.name),e.saveUserRole(n.role),r(function(){o.showSuccess=!1,r(function(){t.go("dash.queue")},800)},5e3)},function(e){o.errorMsg=e,o.showError=!0,r(function(){o.showError=!1},5e3)})}var o=this;angular.extend(o,{register:{name:"",mail:"",pass:"",pass2:""},showError:!1,showSuccess:!1,submitRegistration:n})}angular.module("app").controller("RegisterCtrl",e),e.$inject=["AuthService","$timeout","$state"]}(),function(){function e(e,r,t){function n(){r.getAllProfileSettings().then(function(e){u.allSettings=e},function(e){t.swal("Server-Fehler",e,"error")})}function o(e){u.selectedSetting=i(e,4)}function l(e){r.removeSetting(e).then(function(){n()},function(e){t.swal("Server-Fehler",e,"error")})}function s(){if(u.selectedSetting){try{var e=JSON.parse(u.selectedSetting)}catch(o){return t.swal("Eingabe-Fehler","Kein gültiger JSON-String","error")}e.name||t.swal("Eingabe-Fehler","Kein gültiger Name eingegeben","error"),r.submitNewSettings(e).then(function(){n()},function(e){t.swal("Server-Fehler",e,"error")})}}function i(e,r){return JSON.stringify(e,null,Number(r))}var u=this;angular.extend(u,{allSettings:null,newOne:!1,selectedSetting:null,insertSettings:o,removeSetting:l,submitNewSettings:s}),n()}angular.module("app").controller("SettingsCtrl",e),e.$inject=["ngTableParams","ProfileService","SweetAlert","$modal","$scope"]}(),function(){function e(e,r,t,n){function o(n){var o=t.defer();return e({method:"POST",url:r.apiUrl+p.loginUrl,data:{mail:n.user,pass:n.pass}}).success(function(e){o.resolve(e)}).error(function(e,r){o.reject(e,r)}),o.promise}function l(n){var o=t.defer();return e({method:"POST",url:r.apiUrl+p.registerUrl,data:n}).success(function(e){o.resolve(e)}).error(function(e,r){o.reject(e,r)}),o.promise}function s(){return n.get("authToken")}function i(){return n.get("userId")}function u(){return n.get("userName")}function a(){return n.get("userRole")}function c(){n.remove("authToken"),n.remove("userId"),n.remove("userName"),n.remove("userRole")}function f(e){n.set("authToken",e)}function g(e){n.set("userId",e)}function d(e){n.set("userName",e)}function h(e){n.set("userRole",e)}var p={loginUrl:"/user/login",registerUrl:"/user/register",sessionUrl:"/user/session",getAuth:o,getRegistration:l,getToken:s,getUserId:i,getUserName:u,getUserRole:a,logout:c,saveToken:f,saveUserId:g,saveUserName:d,saveUserRole:h};return p}angular.module("app").factory("AuthService",e),e.$inject=["$http","config","$q","localStorageService"]}(),function(){function e(e,r,t){function n(){var n=t.defer();return e({method:"GET",url:r.apiUrl+u.allProfilesUrl}).success(function(e){n.resolve(e)}).error(function(e,r){n.reject(e,r)}),n.promise}function o(){var n=t.defer();return e({method:"GET",url:r.apiUrl+u.allSettingsUrl}).success(function(e){for(var r=0;r<e.length;r++){var t=e[r].json;e[r]=JSON.parse(t)}n.resolve(e)}).error(function(e,r){n.reject(e,r)}),n.promise}function l(n){var o=t.defer();return console.log(n),e({method:"DELETE",url:r.apiUrl+u.removeSettingUrl,data:{name:n}}).success(function(e){o.resolve(e)}).error(function(e,r){o.reject(e,r)}),o.promise}function s(n){var o=t.defer();return e({method:"POST",url:r.apiUrl+u.newProfileUrl,data:{profile:n}}).success(function(e){o.resolve(e)}).error(function(e,r){o.reject(e,r)}),o.promise}function i(n){var o=t.defer();return e({method:"POST",url:r.apiUrl+u.newSettingsUrl,data:{name:n.name,settings:n}}).success(function(e){o.resolve(e)}).error(function(e,r){o.reject(e,r)}),o.promise}var u={allProfilesUrl:"/profiles/all",allSettingsUrl:"/settings/all",newProfileUrl:"/profiles/save",newSettingsUrl:"/settings/save",removeSettingUrl:"/settings/remove",getAllProfiles:n,getAllProfileSettings:o,removeSetting:l,submitNewProfile:s,submitNewSettings:i};return u}angular.module("app").factory("ProfileService",e),e.$inject=["$http","config","$q"]}(),function(){function e(e,r,t){function n(){try{l.socket=io.connect(e.apiUrl)}catch(r){return t.swal("Server-Fehler","Es konnte keine Verbindung zum WebSocket hergestellt werden","error")}l.socket.on("connect",function(){o()})}function o(){}var l={socket:null,connectSocket:n};return l}angular.module("app").factory("SocketService",e),e.$inject=["config","$q","SweetAlert"]}();